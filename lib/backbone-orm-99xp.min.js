/**
* @license
* backbone-orm 99xp
* ----------------------------------
* v0.8.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-orm.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("backbone"),require("validate-99xp")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","backbone","validate-99xp"],e):e((t=t||self).BackboneORM={},t._,t.Backbone,t.v)}(this,function(t,e,i,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n;var r={},s={_migration:{alter:!0},migration(){return!!e.result(this,"canMigrate")&&this._migration},syncMigration(){var t=e.result(this,"migration");if(t)return!0===t&&(t={}),this.entity.sync(t)},defineEntity(t){var i,n=this.getConnection();switch(!0){case e.isArray(t):i=n.isDefined(i[0])?n.model(i[0]):n.define(i[0],i[1]||{},i[2]||{});break;case"function"==typeof t:i=t.sequelize?t:t()}return i}},o={preinitialize(){this.setEntity()},setEntity(){if(this.entity)return this.entity;var t=e.result(this,"entityDefinition")||r.error("Entity Definition not found");return this.entity=this.defineEntity(t),this.entity},getConnection(){return e.result(this,"conn")||e.result(r,"conn")||r.error("Database connection not set")},sync(t,i,n){return i.trigger("request",t,i,n),this["sync"+e.capitalize(t)](t,i,n)},syncRead(t,i,n){var r={};if(this.id?r[this.idAttribute]=this.id:r=this.attributes,r)return this.entity.findOne({where:r}).then(t=>(t=>{n.success(t.dataValues)})(t)).catch(e.bind(this.handleSyncError,this))},syncCreate(t,i,n){var r=e.omit(this.attributes,this.idAttribute);return this.entity.create(r).then(t=>(t=>{var e={};e[i.idAttribute]=t.null,n.success(e)})(t)).catch(e.bind(this.handleSyncError,this))},syncUpdate(t,i,n){var r=e.omit(this.attributes,this.idAttribute),s={where:e.pick(this.attributes,this.idAttribute)};return this.entity.update(r,s).then(t=>(t=>{n.success(t[0])})(t)).catch(e.bind(this.handleSyncError,this))},syncPatch(t,e,i){return this.syncUpdate(t,e,i)},handleSyncError(t){var i=[];if(e.isArray(t.errors))for(let e in t.errors)i.push(t.errors[e].message);else i.push(t.message||t);this.trigger("error",t,i)},validations:(t,e)=>({}),validationErrors(t){this._res.status(400).send({title:"Invalid Data",errors:t})},once(t,n){return e.isArray(t)&&e.isArray(n)&&(this.once(t[0],e.partial(function(t,i){this.off(i[0],i[1]);var n=e.toArray(arguments);n.shift(),n.shift(),t[1].apply(null,n)},t,n)),this.once(n[0],e.partial(function(t,i){this.off(t[0],t[1]);var n=e.toArray(arguments);n.shift(),n.shift(),i[1].apply(null,n)},t,n))),e.bind(i.Model.prototype.once,this)(t,n)}};r.Model=i.Model.extend(e.extend(e.clone(n),s,o));var a={preinitialize(){this.setModelBase(),this.setEntity()},setModelBase(){var t=this.model?this.model:r.Model.extend();this.modelBase=new t},setEntity(){if(this.entity)return this.entity;var t=e.result(this,"entityDefinition")||e.result(this.modelBase,"entityDefinition")||r.error("Entity Definition not found");return this.entity=this.defineEntity(t),this.entity},getConnection(){return e.result(this,"conn")||e.result(this.modelBase,"conn")||e.result(r,"conn")||r.error("Database connection not set")},parse(t,i,n){e.isArray(t)&&e.size(t)>0&&this.add(e.map(t,t=>t.dataValues)),i(this)},findAll(t={},e,i){return"function"!=typeof i&&(i=(()=>{})),this.entity.findAll({where:t}).then(t=>this.parse(t,e,i)).catch(t=>i(t))},saveAll(t,e){var i=this.models.length,n=()=>{--i>0||"function"==typeof t&&t(this)};for(var r in"function"!=typeof e&&(e=(()=>{})),this.models){var s=this.models[r];s.once(["sync",n],["error",e]),s.save()}}};r.Collection=i.Collection.extend(e.extend({},s,a)),r.error=function(t){throw new Error(t)},t.default=r,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-orm-99xp.min.js.map
