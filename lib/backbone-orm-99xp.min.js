/**
* @license
* backbone-orm 99xp
* ----------------------------------
* v1.1.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-orm.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("backbone"),require("validate-99xp"),require("app-exception")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","backbone","validate-99xp","app-exception"],e):e((t=t||self).BackboneORM={},t._,t.Backbone,t.v,t.AppException)}(this,function(t,e,i,r,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,i=i&&i.hasOwnProperty("default")?i.default:i,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var s={},a={_migration:{alter:!0},migration(){return!!e.result(this,"canMigrate")&&this._migration},syncMigration(){var t=e.result(this,"migration");if(t)return!0===t&&(t={}),this.entity.sync(t)},defineEntity(t){var i,r=this.getConnection();switch(!0){case e.isArray(t):i=r.isDefined(t[0])?r.model(t[0]):r.define(t[0],t[1]||{},t[2]||{});break;case"function"==typeof t:i=t.sequelize?t:t()}return i}},o={preinitialize(){this.setEntity()},setEntity(){if(this.entity)return this.entity;var t=e.result(this,"entityDefinition")||s.error("Entity Definition not found");return this.entity=this.defineEntity(t),this.entity},getConnection(){return e.result(this,"conn")||e.result(s,"conn")||s.error("Database connection not set")},sync(t,i,r){return i.trigger("request",t,i,r),this["sync"+e.capitalize(t)](t,i,r)},syncRead(t,i,r){var n={};if(this.id?n[this.idAttribute]=this.id:n=this.attributes,n)return this.entity.findOne({where:n}).then(t=>(t=>{r.success(t.dataValues)})(t)).catch(e.bind(this.handleSyncError,this))},syncCreate(t,i,r){var n=e.omit(this.attributes,this.idAttribute);return this.entity.create(n).then(t=>(t=>{var e={};e[i.idAttribute]=t.dataValues[i.idAttribute],r.success(e)})(t)).catch(e.bind(this.handleSyncError,this))},syncUpdate(t,i,r){var n=e.omit(this.attributes,this.idAttribute),s={where:e.pick(this.attributes,this.idAttribute)};return this.entity.update(n,s).then(t=>(t=>{r.success(t[0])})(t)).catch(e.bind(this.handleSyncError,this))},syncPatch(t,e,i){return this.syncUpdate(t,e,i)},handleSyncError(t){var i=[];if(e.isArray(t.errors))for(let e in t.errors)i.push(t.errors[e].message);else i.push(t.message||t);this.trigger("error",t,i)},validations:(t,e)=>({}),validationErrors:t=>s.error({title:"Invalid Data",errors:t},0,400),once(t,r){return e.isArray(t)&&e.isArray(r)&&(this.once(t[0],e.partial(function(t,i){this.off(i[0],i[1]);var r=e.toArray(arguments);r.shift(),r.shift(),t[1].apply(null,r)},t,r)),this.once(r[0],e.partial(function(t,i){this.off(t[0],t[1]);var r=e.toArray(arguments);r.shift(),r.shift(),i[1].apply(null,r)},t,r))),e.bind(i.Model.prototype.once,this)(t,r)},save(){return new Promise((t,r)=>{this.once(["sync",()=>{t(this)}],["error",t=>{r(t)}]),e.bind(i.Model.prototype.save,this)()})}};s.Model=i.Model.extend(e.extend(e.clone(r),a,o));var h={preinitialize(){this.setModelBase(),this.setEntity()},setModelBase(){var t=this.model?this.model:s.Model.extend();this.modelBase=new t},setEntity(){if(this.entity)return this.entity;var t=e.result(this,"entityDefinition")||e.result(this.modelBase,"entityDefinition")||s.error("Entity Definition not found");return this.entity=this.defineEntity(t),this.entity},getConnection(){return e.result(this,"conn")||e.result(this.modelBase,"conn")||e.result(s,"conn")||s.error("Database connection not set")},parse(t){e.isArray(t)&&e.size(t)>0&&this.add(e.map(t,t=>t.dataValues))},findAll(t={}){return new Promise((e,i)=>this.entity.findAll({where:t}).then(t=>{this.parse(t),e(this)}).catch(t=>{i(t)}))},saveAll(){return new Promise((t,e)=>{var i=this.models.length,r=()=>{--i>0||t(this)},n=[];for(let t in this.models){var s=this.models[t].validate(this.model.attributes,{validateAll:!0});s&&(n=n.concat(s))}n.length&&e(n);for(let t in this.models){this.models[t].save().then(()=>r()).catch(t=>{e(t)})}})}};s.Collection=i.Collection.extend(e.extend({},a,h)),s.error=function(t,e=0,i=500){throw new n(t,e,i)},t.default=s,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-orm-99xp.min.js.map
