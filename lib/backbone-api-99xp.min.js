/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.1.0
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest)}(this,function(t,e,s,r){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r;var i={},o={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):i.dataError("tokenField is not set")},initialize(t,s={}){this.setRouterParameters(s.req,s.res),this.options=e.defaults(e.omit(s,"req","res"),{autoexec:!0}),this.data={},"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(){if(!this._methodsExecution&&(this._methodsExecution=e.clone(this.options.method)),0===e.size(this._methodsExecution))return this._methodsExecution=null,void e.bind(this.options.success,this)();var t=this._methodsExecution.shift();this.exec(t,()=>this.execAll(),this.options.error)},exec(t,s,r){var o=this.methodData(t),a=this.validate(this.getMethodInput(o),{methodData:o});if(null!==a)return this.validationErrors(a);var h=e.bind(this.callApi,this),n=e.partial(h,t,o,s,r);return o.public?n():this.auth?this.exec(this.auth,n):i.dataError(`method "${t}" is not set as public but auth is not set`)},callApi(t,s,r,i){this.setApiCall(s);var o={method:s.method,data:this.getMethodInput(s),headers:e.result2(s,"headers",{},[s],this)};s.public||(o=this.setAuthHeader(o));var a=e.bind("function"==typeof s.before?s.before:(t,e)=>{t(e)},this),h=e.bind(e.partial((t,s,r,i,o)=>{this.listenToOnce(this,"sync",e.bind(()=>{this.data[t]=this.attributes,this.attributes={};try{"function"==typeof s.success&&e.bind(s.success,this)(o,this._req.body,s),"function"==typeof r&&e.bind(r,this)(o,this._req.body,s)}catch(t){this._res.status(500).send({message:"Internal Failure"})}},this)),this.listenToOnce(this,"error",e.bind(()=>{try{"function"==typeof s.error&&e.bind(s.error,this)(this._reqErr.response,o,this._req.body,s),"function"==typeof i?e.bind(i,this)(this._reqErr.response||null,o,this._req.body,s):!this._res._headerSent&&this._res.status(this._reqErr.response?this._reqErr.response.status:500).send(this._reqErr.response?this._reqErr.response.data:null)}catch(t){this._res.status(500).send({message:"Internal Failure"})}},this)),this.save(null,o)},t,s,r,i),this);try{a(h,o)}catch(t){this._res.status(500).send({message:"Internal Failure"})}},test:!1,methodData(t){if(!t||!e.result(this,"methods")[t])return i.dataError("Make sure you've set your method and it's data");var s=e.result(this,"methods")[t]||{};return s.path||i.dataError("Make sure you've set a path for method "+t+"'"),s=this.setHttpMethod(s)},setHttpMethod(t){var s=this.getMethodInput(t);return(t=e.defaults(t,{method:"object"==typeof s&&e.size(s)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return e.result2(t,"data",this._req.body||{},[e.clone(this._req.body),t],this)},url(){return e.result(this,"urlRoot")||e.result(this.collection,"url")||i.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,s){var r=e.result(this,"urlHost")||i.urlError(1),o=e.extend({},e.clone(this.data),{_model:this,_input:this.getMethodInput(s),_params:this._req.params}),a=new RegExp("((?<!:)/{1,})","g");return t=e.template(t)(o),this.urlRoot=[r,t].join("/").replace(a,"/")},sync(t,e,s){var i=[a[s.method],e,s];return r.sync.apply(this,i)},validations(t,s){return e.result2(s.methodData,"validations",{},[t,s],this)},_validate:()=>!0,validationErrors(t){this._res.status(400).send({title:"Invalid Data",errors:t})},setRouterParameters(t,e){t&&e||i.dataError("Initialize requires an object with req and res (express route variables) within"),this._req=t,this._res=e}};e.map(["Model","Collection"],t=>{i[t]=r[t].extend(e.extend(e.clone(s),o))}),i.urlError=function(t){2===t&&i.dataError('A "path" property must be specified in methods list for the current method'),i.dataError('A "urlHost" property or function must be specified')},i.dataError=function(t){throw new Error(t)};var a={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=i,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
